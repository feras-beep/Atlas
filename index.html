import { useEffect, useRef, useState } from "react";
import { Canvas } from "@react-three/fiber";
import { OrbitControls } from "@react-three/drei";
import * as THREE from "three";

const brainRegions = {
  "Broca’s Area": ["fMRI", "MEG", "ECoG"],
  "Wernicke’s Area": ["TMS", "EEG"],
  "Motor Cortex": ["Cortical Stimulation", "DTI"],
};

function BrainModel({ onSelectRegion }) {
  const meshRef = useRef();
  const [selectedRegion, setSelectedRegion] = useState(null);

  useEffect(() => {
    if (!meshRef.current) return;
    meshRef.current.traverse((child) => {
      if (child.isMesh) {
        child.material = new THREE.MeshStandardMaterial({
          color: "lightgray", transparent: true, opacity: 0.8,
        });
        child.userData = { name: "Brain" };
      }
    });
  }, []);

  const handlePointerDown = (event) => {
    event.stopPropagation();
    const regionName = Object.keys(brainRegions)[Math.floor(Math.random() * Object.keys(brainRegions).length)];
    setSelectedRegion(regionName);
    onSelectRegion(regionName);
  };

  return (
    <mesh ref={meshRef} onPointerDown={handlePointerDown}>
      <sphereGeometry args={[1.5, 32, 32]} />
      <meshStandardMaterial color="lightgray" />
    </mesh>
  );
}

export default function App() {
  const [selectedRegion, setSelectedRegion] = useState(null);

  return (
    <div className="h-screen flex flex-col">
      <div className="p-4 text-center bg-gray-800 text-white text-xl font-bold">
        Interactive Brain Language Mapping
      </div>
      <div className="flex-grow relative">
        <Canvas className="w-full h-full" camera={{ position: [0, 0, 5] }}>
          <ambientLight intensity={0.5} />
          <directionalLight position={[2, 2, 2]} />
          <OrbitControls />
          <BrainModel onSelectRegion={setSelectedRegion} />
        </Canvas>
        {selectedRegion && (
          <div className="absolute top-10 left-10 bg-white p-4 rounded-lg shadow-lg">
            <h2 className="text-lg font-bold">{selectedRegion}</h2>
            <ul className="mt-2 list-disc pl-5">
              {brainRegions[selectedRegion].map((tech) => (
                <li key={tech}>{tech}</li>
              ))}
            </ul>
          </div>
        )}
      </div>
    </div>
  );
}
